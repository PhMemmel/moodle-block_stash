{"version":3,"sources":["../src/swap.js"],"names":["showModal","e","swapbtn","currentTarget","courseid","getAttribute","userid","myuserid","Promise","all","getUserStash","userstash","mystash","buildModal","modal","displayModal","context","yourstash","ModalFactory","create","title","body","Templates","render","type","types","SAVE_CANCEL","setSaveButtonText","getRoot","on","ModalEvents","save","myitems","youritems","swapitems","document","getElementsByClassName","Object","entries","forEach","item","push","id","quantity","value","formelement","querySelector","submitSwap","destroy","hidden","show","items","Ajax","call","methodname","args","then","allitems","init","addEventListener"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * User swap code\n *\n * @package    block_stash\n * @copyright  2019 Adrian Greeve - adriangreeve.com\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\n\nconst showModal = async(e) => {\n    let swapbtn = e.currentTarget;\n    let courseid = swapbtn.getAttribute('data-courseid');\n    let userid = swapbtn.getAttribute('data-userid');\n    let myuserid = swapbtn.getAttribute('data-myuserid');\n    let [userstash, mystash] = await Promise.all([getUserStash(courseid, userid), getUserStash(courseid, myuserid)]);\n\n    const modal = await buildModal(courseid, userstash, mystash, userid, myuserid);\n    displayModal(modal);\n};\n\nconst buildModal = async(courseid, userstash, mystash, userid, myuserid) => {\n    let context = {\n            courseid: courseid,\n            yourstash: userstash,\n            mystash: mystash,\n            userid: userid,\n            myuserid: myuserid\n    };\n    return ModalFactory.create({\n        title: 'Swap stuff',\n        body: Templates.render('block_stash/swap_form', context),\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n};\n\nconst displayModal = async(modal) => {\n    modal.setSaveButtonText('Send trade request');\n    modal.getRoot().on(ModalEvents.save, () => {\n        // Do stuff here.\n\n        let myitems = [];\n        let youritems = [];\n\n        let swapitems = document.getElementsByClassName('block-stash-quantity');\n        Object.entries(swapitems).forEach((item) => {\n            if (item[1].getAttribute('data-select-type') == 'your-items') {\n                youritems.push({id: item[1].getAttribute('data-itemid'), quantity: item[1].value});\n            } else {\n                myitems.push({id: item[1].getAttribute('data-itemid'), quantity: item[1].value});\n            }\n        });\n\n        let formelement = document.querySelector('form');\n        let courseid = formelement.getAttribute('data-courseid');\n        let userid = formelement.getAttribute('data-userid');\n        let myuserid = formelement.getAttribute('data-myuserid');\n\n        submitSwap(userid, myuserid, courseid, youritems, myitems);\n        modal.destroy();\n\n    });\n\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n\n    modal.show();\n};\n\nconst submitSwap = (userid, myuserid, courseid, items, myitems) => {\n        return Ajax.call([{\n            methodname: 'block_stash_create_swap_request',\n            args: {\n                userid: userid,\n                myuserid: myuserid,\n                courseid: courseid,\n                items: items,\n                myitems: myitems\n            }\n        }])[0].then((allitems) => {\n            return allitems;\n        });\n};\n\n\nconst getUserStash = (courseid, userid) => {\n    return Ajax.call([{\n        methodname: 'block_stash_get_user_stash_items',\n        args: {\n            courseid: courseid,\n            userid: userid\n        }\n    }])[0].then((allitems) => {\n        return allitems;\n    });\n};\n\nexport const init = () => {\n    let swapbtn = document.querySelector('[data-swap]');\n    swapbtn.addEventListener('click', showModal);\n};\n"],"file":"swap.min.js"}