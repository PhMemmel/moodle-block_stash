{"version":3,"file":"trade-area.min.js","sources":["../src/trade-area.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Trade module.\n *\n * @copyright  2017 Adrian Greeve <adriangreeve.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/templates',\n    'block_stash/counselor',\n    'block_stash/drop',\n    'core/notification',\n    'block_stash/trade',\n], function($, Templates, Counselor, Drop, notification, Trade) {\n\n    /**\n     * Trade class.\n     *\n     * @class\n     * @param {Node} node The node.\n     */\n    function TradeArea(node) {\n        this._node = $(node);\n        this._setUp();\n        this._update();\n    }\n    TradeArea.prototype._node = null;\n\n    /**\n     * Setup.\n     */\n    TradeArea.prototype._setUp = function() {\n        Counselor.on(Drop.prototype.EVENT_PICKEDUP, this._dropPickedUpListener.bind(this));\n        Counselor.on(Trade.prototype.EVENT_TRADE, this._dropPickedUpListener.bind(this));\n    };\n\n    /**\n     * Whether the item is in this trade area.\n     *\n     * @param {Number} id The item ID.\n     * @return {Boolean}\n     */\n    TradeArea.prototype.containsItem = function(id) {\n        return this.getTradeItemNode(id).length > 0;\n    };\n\n    /**\n     * Listens to drop picked up events.\n     *\n     * @param {Event} e The event.\n     * @param {Object} data The event data.\n     */\n    TradeArea.prototype._dropPickedUpListener = function(e, data) {\n        var userItem = data.useritem;\n        if (this.containsItem(userItem.getItem().get('id'))) {\n            this.updateTradeItemUserQuantity(userItem);\n        }\n    };\n\n    /**\n     * Can the user perform the trade?\n     *\n     * @return {Bool}\n     */\n    TradeArea.prototype.canTradeItems = function() {\n        var removeditemnodes = this._node.find('.removed-items');\n\n        var hasenough = true;\n        removeditemnodes.each(function(i, node) {\n            hasenough = hasenough && $(node).data('hasenough');\n        });\n\n        return hasenough;\n    };\n\n    /**\n     * Get the trade item node.\n     *\n     * @param {Number} id The item ID.\n     * @return {Node}\n     */\n    TradeArea.prototype.getTradeItemNode = function(id) {\n        return this._node.find('.removed-items[data-itemid=' + id + ']');\n    };\n\n    /**\n     * Update the quantity of a user item.\n     *\n     * @param {UserItem} userItem The user item.\n     */\n    TradeArea.prototype.updateTradeItemUserQuantity = function(userItem) {\n        var itemid = userItem.getItem().get('id'),\n            node = this.getTradeItemNode(itemid),\n            newQuantity = parseInt(userItem.get('quantity'), 10),\n            quantity = parseInt(node.attr('data-quantity'), 10),\n            tradeid = node.parent().attr('data-tradeid'),\n            name = userItem.getItem().get('name'),\n            enoughitems = (newQuantity >= quantity);\n\n        var context = {\n            enoughitems: enoughitems,\n            itemid: itemid,\n            quantity: quantity,\n            name: name,\n            userquantity: newQuantity\n        };\n\n        // I want to switch the template to show the new values.\n        Templates.render('block_stash/tradeitem_detail', context).done(function(html, js) {\n            Templates.replaceNodeContents($('.block-stash-trade-item-' + itemid + '[data-tradeid=\"' + tradeid + '\"]'), html, js);\n            this._update();\n        }.bind(this)).fail(notification.exception);\n    };\n\n    /**\n     * Update the widget.\n     *\n     * @return {Void}\n     */\n    TradeArea.prototype._update = function() {\n        var btn = this._node.find('.accept-trade button').first();\n        if (!btn) {\n            return;\n        }\n\n        if (!this.canTradeItems()) {\n            btn.prop('disabled', true);\n        } else {\n            btn.prop('disabled', false);\n        }\n    };\n\n    return /** @alias module:block_stash/trade-area */ TradeArea;\n\n});\n"],"names":["define","$","Templates","Counselor","Drop","notification","Trade","TradeArea","node","_node","_setUp","_update","prototype","on","EVENT_PICKEDUP","this","_dropPickedUpListener","bind","EVENT_TRADE","containsItem","id","getTradeItemNode","length","e","data","userItem","useritem","getItem","get","updateTradeItemUserQuantity","canTradeItems","removeditemnodes","find","hasenough","each","i","itemid","newQuantity","parseInt","quantity","attr","tradeid","parent","name","context","enoughitems","userquantity","render","done","html","js","replaceNodeContents","fail","exception","btn","first","prop"],"mappings":";;;;;;AAsBAA,gCAAO,CACH,SACA,iBACA,wBACA,mBACA,oBACA,sBACD,SAASC,EAAGC,UAAWC,UAAWC,KAAMC,aAAcC,gBAQ5CC,UAAUC,WACVC,MAAQR,EAAEO,WACVE,cACAC,iBAETJ,UAAUK,UAAUH,MAAQ,KAK5BF,UAAUK,UAAUF,OAAS,WACzBP,UAAUU,GAAGT,KAAKQ,UAAUE,eAAgBC,KAAKC,sBAAsBC,KAAKF,OAC5EZ,UAAUU,GAAGP,MAAMM,UAAUM,YAAaH,KAAKC,sBAAsBC,KAAKF,QAS9ER,UAAUK,UAAUO,aAAe,SAASC,WACjCL,KAAKM,iBAAiBD,IAAIE,OAAS,GAS9Cf,UAAUK,UAAUI,sBAAwB,SAASO,EAAGC,UAChDC,SAAWD,KAAKE,SAChBX,KAAKI,aAAaM,SAASE,UAAUC,IAAI,aACpCC,4BAA4BJ,WASzClB,UAAUK,UAAUkB,cAAgB,eAC5BC,iBAAmBhB,KAAKN,MAAMuB,KAAK,kBAEnCC,WAAY,SAChBF,iBAAiBG,MAAK,SAASC,EAAG3B,MAC9ByB,UAAYA,WAAahC,EAAEO,MAAMgB,KAAK,gBAGnCS,WASX1B,UAAUK,UAAUS,iBAAmB,SAASD,WACrCL,KAAKN,MAAMuB,KAAK,8BAAgCZ,GAAK,MAQhEb,UAAUK,UAAUiB,4BAA8B,SAASJ,cACnDW,OAASX,SAASE,UAAUC,IAAI,MAChCpB,KAAOO,KAAKM,iBAAiBe,QAC7BC,YAAcC,SAASb,SAASG,IAAI,YAAa,IACjDW,SAAWD,SAAS9B,KAAKgC,KAAK,iBAAkB,IAChDC,QAAUjC,KAAKkC,SAASF,KAAK,gBAC7BG,KAAOlB,SAASE,UAAUC,IAAI,QAG9BgB,QAAU,CACVC,YAHeR,aAAeE,SAI9BH,OAAQA,OACRG,SAAUA,SACVI,KAAMA,KACNG,aAAcT,aAIlBnC,UAAU6C,OAAO,+BAAgCH,SAASI,KAAK,SAASC,KAAMC,IAC1EhD,UAAUiD,oBAAoBlD,EAAE,2BAA6BmC,OAAS,kBAAoBK,QAAU,MAAOQ,KAAMC,SAC5GvC,WACPM,KAAKF,OAAOqC,KAAK/C,aAAagD,YAQpC9C,UAAUK,UAAUD,QAAU,eACtB2C,IAAMvC,KAAKN,MAAMuB,KAAK,wBAAwBuB,QAC7CD,MAIAvC,KAAKe,gBAGNwB,IAAIE,KAAK,YAAY,GAFrBF,IAAIE,KAAK,YAAY,KAMsBjD"}